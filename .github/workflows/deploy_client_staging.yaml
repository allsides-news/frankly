name: Deploy Client to Staging
concurrency: staging
on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  deploy_client_staging:
    name: Deploy Client To Staging
    runs-on: ubuntu-latest
    environment: staging
    defaults:
      run:
        working-directory: client
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            client:
              - 'client/**'

      - name: Set Up Flutter
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.2" # could read version from pubspec file, but would need to be exact
          channel: "stable"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:"
          pub-cache-key: "flutter-pub-:os:-:channel:-:version:-:arch:-:hash:"
          pub-cache-path: "/home/runner/.pub-cache" #hardcoded not ideal, but no way to reference $HOME

      - name: Install Dependencies
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        run: flutter pub get

      - name: Set Build Number and Version
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        run: |
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          # Extract version from pubspec.yaml
          BASE_VERSION=$(grep '^version: ' client/pubspec.yaml | sed 's/version: //')
          # Create semantic version for staging: BASE_VERSION-staging+BUILD_NUMBER (e.g., 1.0.0-staging+123)
          VERSION="${BASE_VERSION}-staging+${{ github.run_number }}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Building version: ${VERSION}"

      - name: Create Sentry release tag off latest git commit hash
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        continue-on-error: true
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          curl -sL https://sentry.io/get-cli | bash
          sentry-cli releases new -p $SENTRY_PROJECT $(sentry-cli releases propose-version)
          echo "CURRENT_RELEASE=$(sentry-cli releases propose-version)" >> "$GITHUB_ENV"

      - name: Update Product Version
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        run: |
          sed -i 's/__VERSION__/${{ env.VERSION }}/g' ${{ github.workspace }}/client/web/index.html

      - name: Update Google Auth Client ID
        if: steps.changes.outputs.client == 'true'  || github.event_name== 'workflow_dispatch'
        run: |
          sed -i 's/__GOOGLE_ID__/${{ secrets.GOOGLE_SIGN_IN_ID }}/g' ${{ github.workspace }}/client/web/index.html

      - name: Create .env.json file
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        run: |
          cat > ${{ github.workspace }}/.env.json << 'EOF'
          {
            "FIREBASE_API_KEY": "${{ secrets.FIREBASE_API_KEY }}",
            "FIREBASE_APP_ID": "${{ secrets.FIREBASE_APP_ID }}",
            "FIREBASE_MESSAGING_SENDER_ID": "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            "FIREBASE_PROJECT_ID": "${{ secrets.APP_STAGING_PROJECT_ID }}",
            "FIREBASE_AUTH_DOMAIN": "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            "FIREBASE_DATABASE_URL": "${{ secrets.FIREBASE_DATABASE_URL }}",
            "FIREBASE_STORAGE_BUCKET": "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            "FIREBASE_MEASUREMENT_ID": "${{ secrets.FIREBASE_MEASUREMENT_ID }}",
            "FUNCTIONS_URL_PREFIX": "${{ secrets.FUNCTIONS_URL_PREFIX }}",
            "SHARE_LINK_URL": "${{ secrets.APP_STAGING_FULL_URL }}/share",
            "ENABLE_FAKE_PARTICIPANTS": "true",
            "ENABLE_DEV_EVENT_SETTINGS": "true",
            "ENABLE_DEV_ADMIN_SETTINGS": "true",
            "ENABLE_TRACE_LOG": "true",
            "SENTRY_RELEASE": "${{ env.CURRENT_RELEASE }}",
            "SENTRY_ENVIRONMENT": "staging",
            "SENTRY_DSN": "${{ secrets.SENTRY_DSN }}",
            "MATOMO_URL": "${{ secrets.MATOMO_URL}}",
            "MATOMO_SITE_ID": "${{ secrets.MATOMO_SITE_ID}}",
             "APP_NAME": "AllSides",
            "APP_URL": "https://roundtables.allsides.com",
            "TERMS_URL": "https://roundtables.allsides.com/terms",
            "PRICING_URL": "https://roundtables.allsides.com/pricing",
            "ABOUT_URL": "https://allsides.com/roundtables",
            "PRIVACY_POLICY_URL": "https://roundtables.allsides.com/privacy",
            "HELP_CENTER_URL": "https://rebootingsocialmedia.notion.site/Frankly-Help-Center-23b4f9a120a344d4af2b2ce44b2ae229",
            "CREATE_TEMPLATE_HELP_URL": "https://rebootingsocialmedia.notion.site/Creating-and-Managing-Events-552a42e4a09549b788e1901536a25965",
            "CREATE_EVENT_HELP_URL": "https://rebootingsocialmedia.notion.site/Creating-and-Managing-Events-552a42e4a09549b788e1901536a25965",
            "TROUBLESHOOTING_GUIDE_URL": "https://rebootingsocialmedia.notion.site/Troubleshooting-c6f922b816a742a9bba4bf000e84565d",
            "LOGO_URL": "https://res.cloudinary.com/dh0vegjku/image/upload/v1725488238/frankly_assets/Frankly-Icon-144x144_ex8nky.png",
            "SIDEBAR_FOOTER": "AllSides Roundtables is operated by AllSides Technologies Inc.",
            "COPYRIGHT_STATEMENT": "2025 AllSides Technologies Inc.",
            "CLOUDINARY_IMAGE_PRESET": "${{ secrets.CLOUDINARY_IMAGE_PRESET }}",
            "CLOUDINARY_VIDEO_PRESET": "${{ secrets.CLOUDINARY_VIDEO_PRESET }}",
            "CLOUDINARY_DEFAULT_PRESET": "${{ secrets.CLOUDINARY_DEFAULT_PRESET }}",
            "CLOUDINARY_CLOUD_NAME": "${{ secrets.CLOUDINARY_CLOUD_NAME }}",
            "LINK_PREVIEW_API_KEY": "${{ secrets.LINK_PREVIEW_API_KEY }}"
          }
          EOF

      - name: Build the Flutter App
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        run: flutter build web --release --build-number=${{ env.BUILD_NUMBER }} --source-maps --web-renderer html -t lib/main.dart --dart-define-from-file=${{ github.workspace }}/.env.json

      - name: Upload sourcemaps to Sentry
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        continue-on-error: true
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: flutter packages pub run sentry_dart_plugin --sentry-define=release=$CURRENT_RELEASE

      - name: Deploy to Firebase Hosting
        if: steps.changes.outputs.client == 'true' || github.event_name== 'workflow_dispatch'
        uses: w9jds/firebase-action@v13.22.1
        with:
          args: deploy --only hosting --force
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          PROJECT_ID: ${{ secrets.APP_STAGING_PROJECT_ID }}
