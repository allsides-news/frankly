name: Deploy Client to Production
concurrency: production
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy_client_prod:
    name: Deploy Client To Production
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: client
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.2" # could read version from pubspec file, but would need to be exact
          channel: "stable"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:"
          pub-cache-key: "flutter-pub-:os:-:channel:-:version:-:arch:-:hash:"
          pub-cache-path: "/home/runner/.pub-cache" #hardcoded not ideal, but no way to reference $HOME

      - name: Install Dependencies
        run: flutter pub get

      - name: Set Build Number and Version
        run: |
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          # Extract version from pubspec.yaml
          BASE_VERSION=$(grep '^version: ' client/pubspec.yaml | sed 's/version: //')
          # Create semantic version: BASE_VERSION+BUILD_NUMBER (e.g., 1.0.0+123)
          VERSION="${BASE_VERSION}+${{ github.run_number }}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Building version: ${VERSION}"

      - name: Update Product Version
        run: |
          sed -i 's/__VERSION__/${{ env.VERSION }}/g' ${{ github.workspace }}/client/web/index.html

      - name: Update Google Auth Client ID
        run: |
          sed -i 's/__GOOGLE_ID__/${{ secrets.GOOGLE_SIGN_IN_ID }}/g' ${{ github.workspace }}/client/web/index.html

      - name: Create .env.json file
        run: |
          cat > ${{ github.workspace }}/.env.json << 'EOF'
          {
            "FIREBASE_API_KEY": "${{ secrets.FIREBASE_API_KEY }}",
            "FIREBASE_APP_ID": "${{ secrets.FIREBASE_APP_ID }}",
            "FIREBASE_MESSAGING_SENDER_ID": "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            "FIREBASE_PROJECT_ID": "${{ secrets.APP_PROD_PROJECT_ID }}",
            "FIREBASE_AUTH_DOMAIN": "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            "FIREBASE_DATABASE_URL": "${{ secrets.FIREBASE_DATABASE_URL }}",
            "FIREBASE_STORAGE_BUCKET": "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            "FIREBASE_MEASUREMENT_ID": "${{ secrets.FIREBASE_MEASUREMENT_ID }}",
            "FUNCTIONS_URL_PREFIX": "${{ secrets.FUNCTIONS_URL_PREFIX }}",
            "SHARE_LINK_URL": "${{ secrets.APP_FULL_URL }}/share",
            "SENTRY_RELEASE": "${{ env.VERSION }}",
            "SENTRY_ENVIRONMENT": "production",
            "SENTRY_DSN": "${{ secrets.SENTRY_DSN }}",
            "MATOMO_URL": "${{ secrets.MATOMO_URL}}",
            "MATOMO_SITE_ID": "${{ secrets.MATOMO_SITE_ID}}",
            "APP_NAME": "AllSides Roundtables",
            "APP_URL": "https://roundtables.allsides.com",
            "TERMS_URL": "https://www.allsides.com/terms-of-use",
            "PRICING_URL": "https://roundtables.allsides.com/pricing",
            "ABOUT_URL": "https://www.allsides.com/national-roundtable-political-violence",
            "PRIVACY_POLICY_URL": "https://www.allsides.com/privacy",
            "HELP_CENTER_URL": "https://www.notion.so/allsides/Roundtables-Help-Center-29ba7a1b66cc801b85c1fc7613aaca34",
            "CREATE_TEMPLATE_HELP_URL": "https://www.notion.so/allsides/Roundtables-Help-Center-29ba7a1b66cc801b85c1fc7613aaca34",
            "CREATE_EVENT_HELP_URL": "https://www.notion.so/allsides/Roundtables-Help-Center-29ba7a1b66cc801b85c1fc7613aaca34",
            "TROUBLESHOOTING_GUIDE_URL": "https://www.notion.so/allsides/Roundtables-Help-Center-29ba7a1b66cc801b85c1fc7613aaca34",
            "LOGO_URL": "https://img.allsides.com/sites/default/files/AllSides-Icon.png",
            "SIDEBAR_FOOTER": "${{ secrets.SIDEBAR_FOOTER }}",
            "COPYRIGHT_STATEMENT": "${{ secrets.COPYRIGHT_STATEMENT }}",
            "CLOUDINARY_IMAGE_PRESET": "${{ secrets.CLOUDINARY_IMAGE_PRESET }}",
            "CLOUDINARY_VIDEO_PRESET": "${{ secrets.CLOUDINARY_VIDEO_PRESET }}",
            "CLOUDINARY_DEFAULT_PRESET": "${{ secrets.CLOUDINARY_DEFAULT_PRESET }}",
            "CLOUDINARY_CLOUD_NAME": "${{ secrets.CLOUDINARY_CLOUD_NAME }}",
            "LINK_PREVIEW_API_KEY": "${{ secrets.LINK_PREVIEW_API_KEY }}",
            "SUBSCRIPTION_SERVICES_AGREEMENT_URL": "${{ secrets.SUBSCRIPTION_SERVICES_AGREEMENT_URL }}",
            "FIREBASE_DATABASE_ID": "${{ secrets.FIREBASE_DATABASE_ID }}"
          }
          EOF

      - name: Build the Flutter App
        run: flutter build web --release --build-number=${{ env.BUILD_NUMBER }} --source-maps --web-renderer html -t lib/main.dart --dart-define-from-file=${{ github.workspace }}/.env.json

      - name: Upload sourcemaps to Sentry
        continue-on-error: true
        env:
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: flutter packages pub run sentry_dart_plugin --sentry-define=release=${{ env.VERSION }}

      - name: Deploy to Firebase Hosting
        uses: w9jds/firebase-action@v13.22.1
        with:
          args: deploy --only hosting --force
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          PROJECT_ID: ${{ secrets.APP_PROD_PROJECT_ID }}
